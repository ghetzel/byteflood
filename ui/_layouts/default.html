<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    {{- if .page.refresh }}
    <meta http-equiv="refresh" content="{{ .page.refresh }}">
    {{ end -}}

    <!-- jQuery first, then Tether, then Bootstrap JS. -->
    <script src="/js/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <script src="/js/stapes.min.js" integrity="sha384-l+Z/WtSkegBMMzrBOVlkaXa+1kXdJSBKmuhw0t6VTyan4gzqm+L/Nd5BS+kik166" crossorigin="anonymous"></script>
    <script src="/js/bootstrap-notify.min.js" integrity="sha384-Qnyy4lkYCL9J8NhIWAT7bMPccirUwfiBj7PLqr1ZBlSSJ0+A2XDB0UlqZcg+0VGS" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/font-awesome.min.css" integrity="sha384-oZMfhCtQRrSYbsX24SR/ieTzAUPm2W17TOVtEMqi/t72HLoBATmm7J82ezlfk7j5" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/app.css">

    <title>Byteflood{{ if .page.title }} :: {{ .page.title }}{{ end }}</title>

    <script type="text/javascript">
      $(function(){
        var Byteflood = Stapes.subclass({
          constructor: function(){
            // prevent normal form submissions, we'll handle them here
            $('form').on('submit', function(e){
              this.submitForm(e);
              e.preventDefault();
            }.bind(this));
          },

          notify: function(message, type, details, config){
            $.notify($.extend(details, {
              'message': message,
            }), $.extend(config, {
              'type': (type || 'info'),
            }));
          },

          queueFileForDownload: function(session, file_id) {
            $.ajax('/api/queue/'+session+'/'+file_id, {
              method: 'POST',
              success: function(){
                this.notify('File '+file_id+' has been queued for download.');
              }.bind(this),
            });
          },

          scan: function() {
            var scanRequest = '';

            if(arguments.length){
              scanRequest = JSON.stringify({
                'labels': $.makeArray(arguments),
              });
            }

            $.ajax('/api/db/actions/scan?force=true', {
              method: 'POST',
              data: scanRequest,
              success: function(){
                location.reload();
              }.bind(this),
            });
          },

          delete: function(model, id, callback) {
            if(confirm("Are you sure you want to remove this item?") === true){
              $.ajax('/api/'+model+'/'+id.toString(), {
                method: 'DELETE',
                success: function(){
                  if(callback){
                    callback.bind(this)();
                  }else{
                    location.reload();
                  }
                }.bind(this),
              });
            }
          },

          submitForm: function(event){
            var form = $(event.target);
            var url = '';

            if(form.action && form.action.length > 0){
              url = form.action;
            }else if(name = form.attr('name')){
              url = '/api/' + name;
            }else{
              this.notify('Could not determine path to submit data to', 'error');
              return;
            }

            var createNew = true;
            var record = {
              'fields': {},
            };

            $.each(form.serializeArray(), function(i, field) {
              if(field.value == '' || field.value == '0'){
                delete field['value'];
              }

              if(field.name == "id"){
                if(field.value){
                  createNew = false;
                }

                record['id'] = field.value;
              }else if(field.value !== undefined){
                record['fields'][field.name] = field.value;
              }
            });

            $.ajax(url, {
              method: (form.attr('method') || (createNew ? 'POST' : 'PUT')),
              data: JSON.stringify({
                'records': [record],
              }),
              success: function(){
                var redirectTo = (form.data('redirect-to') || '/'+form.attr('name'));
                location.href = redirectTo;
              }.bind(this),
              error: function(response){
                console.debug(response);

                this.notify(response.responseText, 'danger', {
                  'icon': 'fa fa-warning',
                  'title': '<b>' +
                    response.statusText + ' (HTTP '+response.status.toString()+')' +
                    '<br />' +
                  '</b>',
                });
              }.bind(this),
            })
          },
        });

        window.byteflood = new Byteflood();
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-inverse site-main">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
              <img src="/img/byteflood-text.png">
            </a>
            <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#navbar-header" aria-controls="navbar-header" aria-expanded="false" aria-label="Toggle navigation"></button>
            <div class="collapse navbar-toggleable-xs" id="navbar-header">
              <ul class="nav navbar-nav">
                <li class="nav-item {{ if hasPrefix .request.url.path `/peers` }}active{{end}}">
                  <a class="nav-link" href="/peers">
                    <i class="fa fa-fw fa-share-alt"></i>
                    Peers
                    {{ if hasPrefix .request.url.path `/peers` }}
                    <span class="sr-only">(current)</span>
                    {{ end }}
                  </a>
                </li>
                <li class="nav-item {{ if hasPrefix .request.url.path `/shares` }}active{{end}}">
                  <a class="nav-link" href="/shares">
                    <i class="fa fa-fw fa-folder"></i>
                    Shares
                    {{ if hasPrefix .request.url.path `/shares` }}
                    <span class="sr-only">(current)</span>
                    {{ end }}
                  </a>
                </li>
                <li class="nav-item {{ if hasPrefix .request.url.path `/database` }}active{{end}}">
                  <a class="nav-link" href="/database">
                    <i class="fa fa-fw fa-database"></i>
                    Database
                    {{ if hasPrefix .request.url.path `/database` }}
                    <span class="sr-only">(current)</span>
                    {{ end }}
                  </a>
                </li>
                <li class="nav-item {{ if hasPrefix .request.url.path `/config` }}active{{end}}">
                  <a class="nav-link" href="/config">
                    <i class="fa fa-fw fa-gear"></i>
                    Configuration
                    {{ if hasPrefix .request.url.path `/config` }}
                    <span class="sr-only">(current)</span>
                    {{ end }}
                  </a>
                </li>
                <li class="nav-item {{ if hasPrefix .request.url.path `/about` }}active{{end}}">
                  <a class="nav-link" href="/about">
                    <i class="fa fa-fw fa-question"></i>
                    About
                    {{ if hasPrefix .request.url.path `/about` }}
                    <span class="sr-only">(current)</span>
                    {{ end }}
                  </a>
                </li>
              </ul>
            </div>
        </div>
    </nav>

    <div class="content-container">
      {{ if .page.title }}
      {{ if not .page.hide_title }}
      <h1>{{ .page.title }}</h1>
      {{ end }}
      {{ end }}
      {{ template "content" . }}
    </div>
  </body>
</html>
